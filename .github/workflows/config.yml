name: Build and Test
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  ubuntu:
    strategy:
      matrix:
          version: ["8.0", "8.1", "8.2"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout immutable_cache
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{matrix.version}}
          extensions: igbinary
      - name: phpize
        run: phpize
      - name: configure
        run: ./configure --enable-immutable-cache-debug --enable-immutable-cache-igbinary
      - name: make
        run: make
      - name: test
        run: |
            make test TESTS="-j$(nproc) --show-diff -d immutable_cache.serializer=default tests"
            make test TESTS="-j$(nproc) --show-diff -d immutable_cache.serializer=php tests"
            make test TESTS="-j$(nproc) --show-diff -d immutable_cache.serializer=default -d opcache.enable_cli=1 tests"
            make test TESTS="-j$(nproc) --show-diff -d immutable_cache.serializer=php -d opcache.enable_cli=1 tests"
      - name: test with igbinary
        run: |
            PECL_EXTENSION_DIR=$(php -r "echo ini_get('extension_dir');")
            echo "Pecl extensions are installed in $PECL_EXTENSION_DIR"
            cp "$PECL_EXTENSION_DIR/igbinary.so" modules/

            php -d extension=modules/immutable_cache.so -d extension=modules/igbinary.so -d immutable_cache.serializer=igbinary -r 'phpinfo();' |grep -i immutable_cache.serializer
            make test TESTS="-j$(nproc) --show-diff -d extension=$PWD/modules/igbinary.so -d immutable_cache.serializer=igbinary tests"
      - name: test with valgrind
        run: |
            if php -r 'exit(PHP_VERSION_ID>=80100?0:1);'; then
                sudo apt install -y valgrind
                make test TESTS="-j$(nproc) --show-diff --show-mem -d immutable_cache.serializer=php tests -m"
            else
                echo 'Skip valgrind checks in php 8.0 because it has an unrelated warning about zend_string_equal_val due to its use of custom assembly.'
            fi
  windows:
    defaults:
      run:
        shell: cmd
    strategy:
      matrix:
          version: ["8.0", "8.1", "8.2"]
          arch: [x64]
          ts: [nts, ts]
    runs-on: windows-latest
    steps:
      - name: Checkout immutable_cache
        uses: actions/checkout@v2
      - name: Setup PHP
        id: setup-php
        uses: cmb69/setup-php-sdk@v0.6
        with:
          version: ${{matrix.version}}
          arch: ${{matrix.arch}}
          ts: ${{matrix.ts}}
      - name: Enable Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{matrix.arch}}
          toolset: ${{steps.setup-php.outputs.toolset}}
      - name: phpize
        run: phpize
      - name: configure
        run: configure --enable-immutable-cache --enable-debug-pack --with-prefix=${{steps.setup-php.outputs.prefix}}
      - name: make
        run: nmake
      - name: test
        run: nmake test TESTS="--show-diff tests"
      - name: package
        run: |
          md .install
          copy LICENSE .install
          if exist x64 (
            if exist x64\Release (set prefix=x64\Release) else set prefix=x64\Release_TS
          ) else (
            if exist Release (set prefix=Release) else set prefix=Release_TS
          )
          copy %prefix%\php_immutable_cache.dll .install
          copy %prefix%\php_immutable_cache.pdb .install
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v2
#       with:
#         name: immutable_cache-${{matrix.version}}-${{matrix.arch}}-${{matrix.ts}}
#         path: .install
